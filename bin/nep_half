#!/usr/bin/env python
import numpy as np
import mcase.particle_moves as mcp
from ase.io import read, write
from ase.units import kB
from pynep.calculate import NEP
from mcase.reader import read_input
from sys import argv

settings = read_input(argv[1])
rng = np.random.default_rng()

# setup system
walker = read(settings['xyz'])
walker.calc = NEP(settings['model'])

# setup simulation
temperature = float(settings['temperature'])
timestep = float(settings['timestep'])
number_samples = int(settings['samples'])
beta = 1.0/(kB*temperature)
scale = np.sqrt(2*timestep)

# partition system
dim = int(settings['dim']) # can be either 0, 1, or 2 (x, y, z)
partition = float(settings['partition']) # 0 to 1, separate by scaled coordinates
mask = (walker.get_scaled_positions(wrap=True)[:,dim] < partition)

# successful read, print out stuff
print('read inputs from ' + argv[1])
print('particles read from ' + settings['xyz'])
print('NEP model read from ' + settings['model'])
print('temperature: %s K (beta = %s eV^-1)' % (temperature, beta))
print('timestep: %s (length scale = %s)' % (timestep, scale))
print('number of samples to calculate: %d' % number_samples)
print('number of particles to move: %d' % np.sum(mask))

# start sampling
accepted = 0
r = walker.get_positions()
energy = walker.get_potential_energy()
force = walker.get_forces()
N = len(walker)

for _ in range(number_samples):
    dr = rng.normal(size=r.shape, scale=scale) + timestep*beta*force
    r_new = np.copy(r)
    r_new[mask] += dr[mask]
    walker.set_positions(r_new)
    energy_new = walker.get_potential_energy()
    force_new = walker.get_forces()
    # accept or reject
    if rng.random() < mcp.acceptance_ratio(r, r_new, energy, energy_new,\
            force, force_new, beta, timestep):
        energy = energy_new
        force = np.copy(force_new)
        r = walker.get_positions(wrap=True) # wrap to avoid blowing up
        accepted += 1
    else:
        walker.set_positions(r)
    print(energy)

# finished
print('particle move acceptance rate: %.2f' % (accepted / number_samples))

print('writing final configuration to', settings['save_xyz'])
write(settings['save_xyz'], walker, format='extxyz')
